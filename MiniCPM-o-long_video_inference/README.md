# MiniCPM-o 长视频推理脚本说明

## 1. 如何使用该脚本进行长视频推理

### 环境依赖
请先确保已安装以下依赖，可通过如下命令一键安装：

```bash
pip install -r requirements.txt
```

### 输入准备
- 将待分析的长视频文件（如 `long_video.mp4`）放在本目录下，或修改 `infer.py` 脚本中的 `video_path` 变量为你的视频路径。
- 确保有充足的显存（建议8GB及以上），否则可适当调小 `max_frames_per_chunk` 或 `max_slice_nums`。

### 运行脚本
在命令行中进入本目录，执行：

```bash
python infer.py
```

运行后，脚本会自动：
- 读取并分析指定视频
- 处理视觉和音频内容
- 最终在本目录下生成 `long_video_audio_result.json`，并在终端输出最终总结结果

### 输出说明
- `long_video_audio_result.json`：包含每个视频块的分析结果和最终综合总结。
- 终端会打印最终的自然语言总结。

### 注意事项
- 默认使用 `openbmb/MiniCPM-o-2_6` 模型，如需更换模型请在 `infer.py` 中修改 `model_path`。
- 支持GPU和CPU，建议优先使用GPU。
- 视频越长、分辨率越高，所需内存和显存越大。

---

## 2. 脚本实现原理简介

本脚本专为长视频的多模态（视觉+音频）理解设计，核心流程如下：

### 1）分块处理
- 脚本会将长视频按帧数分割为多个小块（如每64帧为一块，块间有重叠），逐块推理，避免显存溢出。

### 2）音视频对齐
- 每帧提取对应的1秒音频片段，实现视觉帧与音频的同步分析。

### 3）记忆库机制
- 脚本维护视觉、音频和文本摘要的"记忆库"，每处理一块就将关键信息存入记忆库。
- 采用时间衰减加权采样，优先关注近期内容，兼顾全局上下文。

### 4）多轮推理与总结
- 每块推理时，结合记忆库历史摘要、当前帧和音频，生成结构化分析结果。
- 所有块处理完后，脚本会再次调用模型对所有块的结果进行整合，输出最终总结。

### 5）高分辨率与自适应
- 支持高清模式（默认开启），如显存不足可关闭或降低分辨率。

---

如需自定义参数（如采样帧率、记忆库大小等），可直接修改 `infer.py` 脚本中的相关参数。

如有问题欢迎提issue或交流！
